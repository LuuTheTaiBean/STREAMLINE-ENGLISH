<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Quiz System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            user-select: none;
        }

        h2 {
            font-weight: 700;
            color: white;
        }

        h4 {
            font-weight: 600;
            margin-bottom: 15px;
        }

        .main-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
        }

        .btn {
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .table {
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }

        .table thead {
            background: #4f46e5;
            color: white;
        }

        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: 0.3s;
        }

        .card:hover {
            transform: scale(1.01);
        }

        .alert {
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        #timer {
            font-size: 24px;
            color: #dc2626;
        }

        select,
        input[type="file"],
        input[type="number"] {
            border-radius: 12px !important;
            padding: 10px !important;
        }

        ul li {
            background: #f3f4f6;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            list-style: none;
        }

        /* ===== QUESTION CARD ===== */

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: 0.3s ease;
        }

        .question-card:hover {
            transform: translateY(-3px);
        }

        .question-title {
            font-weight: 700;
            font-size: 18px;
            color: #4f46e5;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* ===== ANSWERS ===== */

        .answers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }


        .answer-option {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-radius: 14px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            background: white;
            min-height: 55px;
        }


        .answer-option:hover {
            background: #f3f4ff;
            border-color: #6366f1;
        }

        .answer-option input {
            display: none;
        }

        .custom-radio {
            width: 18px;
            height: 18px;
            border: 2px solid #9ca3af;
            border-radius: 50%;
            margin-right: 10px;
            position: relative;
            transition: 0.3s;
        }

        .answer-option input:checked+.custom-radio {
            border-color: #4f46e5;
            background: #4f46e5;
        }

        .answer-option input:checked+.custom-radio::after {
            content: "";
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
        }

        .answer-option input:checked~.answer-text {
            font-weight: 600;
            color: #4f46e5;
        }

        /* ===== RESULT STATE ===== */

        .answer-option.correct {
            border-color: #16a34a !important;
            background: #dcfce7 !important;
        }

        .answer-option.wrong {
            border-color: #dc2626 !important;
            background: #fee2e2 !important;
        }

        .answer-option.disabled {
            pointer-events: none;
            opacity: 0.9;
        }
    </style>


</head>

<body class="bg-light">

    <div class="container py-4">
        <h2 class="text-center mb-5">üöÄ Modern Quiz System</h2>

        <!-- ADMIN / TEACHER -->
        <div id="adminTeacherPanel" class="d-none main-card">
            <h4>üì• Upload Quiz (Excel)</h4>
            <input type="file" id="excelFile" class="form-control mb-3">
            <input type="number" id="quizTime" class="form-control mb-3" placeholder="Nh·∫≠p th·ªùi gian l√†m b√†i (ph√∫t)"
                min="1" value="1">

            <button class="btn btn-success mb-3" onclick="downloadTemplate()">
                üì• T·∫£i file Excel m·∫´u
            </button>
            <h4>üìö Danh s√°ch Quiz</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Ti√™u ƒë·ªÅ</th>
                        <th>Ch·ªß ƒë·ªÅ</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="quizTable"></tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center">
                <h4>üìä Danh s√°ch k·∫øt qu·∫£</h4>
                <button class="btn btn-danger btn-sm" onclick="deleteAllResults()">
                    üóëÔ∏è X√≥a t·∫•t c·∫£
                </button>
            </div>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>H·ªçc sinh</th>
                        <th>Quiz</th>
                        <th>Ch·ªß ƒë·ªÅ</th>
                        <th>ƒêi·ªÉm</th>
                        <th>Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
                        <th>Th·ªùi gian n·ªôp</th>
                        <th>Th·ªùi gian l√†m</th>
                        <th>Chi ti·∫øt</th>
                        <th>X√≥a</th>
                    </tr>
                </thead>


                <tbody id="resultTable"></tbody>
            </table>
        </div>

        <!-- STUDENT -->
        <div id="studentPanel" class="d-none main-card">
            <h4>üìù L√†m Quiz</h4>
            <select id="quizSelect" class="form-select mb-3"></select>
            <button class="btn btn-success mb-3" onclick="startQuiz()">
                ‚ñ∂ B·∫Øt ƒë·∫ßu l√†m b√†i
            </button>
            <div class="alert alert-light shadow-sm">
                ‚è≥ Th·ªùi gian c√≤n l·∫°i:
                <strong id="timer">00:00</strong>
            </div>

            <div id="quizArea"></div>

            <button class="btn btn-primary mt-3" onclick="submitQuiz()">
                N·ªôp b√†i
            </button>
            <hr>
            <h4>üìä ƒêi·ªÉm c·ªßa t√¥i</h4>
            <ul id="myScores"></ul>
        </div>

        <!-- PARENT -->
        <div id="parentPanel" class="d-none main-card">
            <h4>üìä ƒêi·ªÉm c·ªßa con</h4>
            <ul id="childScores"></ul>
        </div>
    </div>

    <script type="module">

        import { auth, db } from "./firebase-config.js";
        import {
            collection, addDoc, getDocs, getDoc,
            doc, query, where, serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        import {
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        import { writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        let currentRole = "";
        let currentQuizId = "";
        let currentQuestions = [];
        let timeLeft = 0;
        let timerInterval = null;
        let quizTimeGlobal = 1;
        let quizStarted = false;
        let quizStartTime = null;


        /* ===============================
           PH√ÇN QUY·ªÄN
        ================================ */

        onAuthStateChanged(auth, async (user) => {

            if (!user) {
                alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
                return;
            }

            const userSnap = await getDoc(doc(db, "users", user.uid));
            const userData = userSnap.data();
            currentRole = userData.role;

            if (currentRole === "admin" || currentRole === "teacher") {
                document.getElementById("adminTeacherPanel").classList.remove("d-none");
                loadAllResults();
                loadAdminQuizList();
            }

            if (currentRole === "student") {
                document.getElementById("studentPanel").classList.remove("d-none");
                loadQuizList();
                loadMyScores();
            }

            if (currentRole === "parent") {
                document.getElementById("parentPanel").classList.remove("d-none");
                loadChildScores(userData.childId);
            }
        });

        /* ===============================
           UPLOAD EXCEL
        ================================ */

        document.getElementById("excelFile")
            .addEventListener("change", handleExcel);

        function handleExcel(e) {

            const file = e.target.files[0];
            const fileName = file.name.replace(/\.[^/.]+$/, "");
            const reader = new FileReader();

            reader.onload = async function (event) {

                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);

                await createQuiz(json, fileName);

            };

            reader.readAsArrayBuffer(file);
        }

        async function createQuiz(questions, fileName) {


            if (!questions.length) {
                alert("File Excel r·ªóng!");
                return;
            }

            const quizTimeInput = document.getElementById("quizTime").value;
            const quizTime = parseInt(quizTimeInput) || 1;

            const quizRef = await addDoc(collection(db, "quizzes"), {
                title: fileName,
                topic: questions[0].topic || "General",
                time: quizTime, // üî• L∆ØU TH·ªúI GIAN
                createdAt: serverTimestamp()
            });


            const questionsCollection = collection(db, "quizzes", quizRef.id, "questions");

            for (let q of questions) {

                if (!["A", "B", "C", "D"].includes(q.correct)) {
                    alert("C·ªôt correct ph·∫£i l√† A/B/C/D");
                    return;
                }

                await addDoc(questionsCollection, {
                    question: q.question,
                    A: q.A,
                    B: q.B,
                    C: q.C,
                    D: q.D,
                    correct: q.correct,
                    topic: q.topic || "General"
                });
            }

            alert("Upload th√†nh c√¥ng!");
            await loadAdminQuizList();
            await loadQuizList();
        }


        /* ===============================
           STUDENT LOAD QUIZ
        ================================ */

        async function loadQuizList() {

            const snapshot = await getDocs(collection(db, "quizzes"));
            const select = document.getElementById("quizSelect");
            select.innerHTML = "";

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                select.innerHTML += `
            <option value="${docSnap.id}">
                ${data.title} - (${data.topic})
            </option>
        `;
            });

            // üëá QUAN TR·ªåNG
            if (select.options.length > 0) {
                select.value = select.options[0].value;
                // await loadQuestions();   // g·ªçi lu√¥n ƒë·ªÉ load c√¢u h·ªèi ƒë·∫ßu ti√™n
            }

            select.addEventListener("change", () => {
                document.getElementById("quizArea").innerHTML = "";
            });
        }


        async function loadQuestions() {

            currentQuizId = document.getElementById("quizSelect").value;
            console.log("Quiz ID:", currentQuizId);

            currentQuestions = [];

            const questionsRef = collection(db, "quizzes", currentQuizId, "questions");
            const snapshot = await getDocs(questionsRef);

            console.log("Total docs:", snapshot.size);

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                console.log("Question data:", data);
                currentQuestions.push({
                    id: docSnap.id,
                    ...data
                });
            });

            if (currentQuestions.length === 0) {
                document.getElementById("quizArea").innerHTML =
                    "<p class='text-danger'>Quiz n√†y ch∆∞a c√≥ c√¢u h·ªèi</p>";
                return;
            }

            // üî• L·∫•y th·ªùi gian t·ª´ quiz
            const quizSnap = await getDoc(doc(db, "quizzes", currentQuizId));
            const quizData = quizSnap.data();
            const quizTime = quizData.time || 1;

            shuffle(currentQuestions);
            renderQuiz();

            if (timerInterval) clearInterval(timerInterval); // reset n·∫øu l√†m l·∫°i
            // startTimer(1); // üëà 1 ph√∫t (b·∫°n c√≥ th·ªÉ ƒë·ªïi)

        }



        function renderQuiz() {

            const area = document.getElementById("quizArea");
            area.innerHTML = "";

            currentQuestions.forEach((q, index) => {

                let answers = [
                    { key: "A", text: q.A },
                    { key: "B", text: q.B },
                    { key: "C", text: q.C },
                    { key: "D", text: q.D }
                ];

                shuffle(answers);

                let html = `
            <div class="question-card">
                <div class="question-title">
                    C√¢u ${index + 1}
                </div>
                <div class="question-text">
                    ${q.question}
                </div>
                <div class="answers">
        `;

                answers.forEach(ans => {
                    html += `
                <label class="answer-option">
                    <input type="radio" name="${q.id}" value="${ans.key}">
                    <span class="custom-radio"></span>
                    <span class="answer-text">${ans.text}</span>
                </label>
            `;
                });

                html += `
                </div>
            </div>
        `;

                area.innerHTML += html;
            });
        }


        window.startQuiz = async function () {

            if (quizStarted) return;

            currentQuizId = document.getElementById("quizSelect").value;

            if (!currentQuizId) {
                alert("Vui l√≤ng ch·ªçn quiz!");
                return;
            }

            quizStarted = true;
            quizStartTime = new Date();

            currentQuestions = [];

            const questionsRef = collection(db, "quizzes", currentQuizId, "questions");
            const snapshot = await getDocs(questionsRef);

            snapshot.forEach(docSnap => {
                currentQuestions.push({
                    id: docSnap.id,
                    ...docSnap.data()
                });
            });

            if (currentQuestions.length === 0) {
                alert("Quiz ch∆∞a c√≥ c√¢u h·ªèi!");
                quizStarted = false;
                return;
            }

            // üî• L·∫•y th·ªùi gian admin ƒë√£ ƒë·∫∑t
            const quizSnap = await getDoc(doc(db, "quizzes", currentQuizId));
            const quizData = quizSnap.data();
            quizTimeGlobal = quizData.time || 1;

            shuffle(currentQuestions);
            renderQuiz();

            startTimer(quizTimeGlobal);
        };

        /* ===============================
           SUBMIT QUIZ
        ================================ */

        window.submitQuiz = async function () {

            if (!quizStarted) {
                alert("B·∫°n ch∆∞a b·∫Øt ƒë·∫ßu l√†m b√†i!");
                return;
            }

            if (timerInterval) clearInterval(timerInterval);


            // Th√™m
            let score = 0;
            let answersDetail = [];

            currentQuestions.forEach(q => {

                const selected = document.querySelector(
                    `input[name="${q.id}"]:checked`
                );

                const selectedAnswer = selected ? selected.value : null;

                if (selectedAnswer === q.correct) {
                    score++;
                }

                answersDetail.push({
                    question: q.question,
                    selected: selectedAnswer,
                    correct: q.correct,
                    A: q.A,
                    B: q.B,
                    C: q.C,
                    D: q.D
                });

            });

            // currentQuestions.forEach(q => {

            //     const options = document.querySelectorAll(
            //         `input[name="${q.id}"]`
            //     );

            //     options.forEach(input => {

            //         const label = input.closest(".answer-option");

            //         // disable h·∫øt ƒë·ªÉ kh√¥ng s·ª≠a ƒë∆∞·ª£c
            //         label.classList.add("disabled");

            //         // n·∫øu l√† ƒë√°p √°n ƒë√∫ng
            //         if (input.value === q.correct) {
            //             label.classList.add("correct");
            //         }

            //         // n·∫øu h·ªçc sinh ch·ªçn sai
            //         if (input.checked && input.value !== q.correct) {
            //             label.classList.add("wrong");
            //         }
            //     });

            //     const selected = document.querySelector(
            //         `input[name="${q.id}"]:checked`
            //     );

            //     if (selected && selected.value === q.correct) {
            //         score++;
            //     }

            // });
            const quizEndTime = new Date();
            const timeTakenSeconds = Math.floor((quizEndTime - quizStartTime) / 1000);

            await addDoc(collection(db, "results"), {
                quizId: currentQuizId,
                studentId: auth.currentUser.uid,
                score: score,
                total: currentQuestions.length,
                timeTaken: timeTakenSeconds,
                startTime: serverTimestamp(),
                submittedAt: serverTimestamp(),
                answers: answersDetail   // üî• th√™m d√≤ng n√†y
            });



            alert("ƒêi·ªÉm c·ªßa b·∫°n: " + score);

            quizStarted = false;
            tabWarningCount = 0;
            document.getElementById("quizArea").innerHTML = "";
            updateTimerDisplay();

            // document.getElementById("quizArea").innerHTML = "";
        };



        /* ===============================
           LOAD K·∫æT QU·∫¢
        ================================ */

        async function loadAllResults() {

            const snapshot = await getDocs(collection(db, "results"));
            const table = document.getElementById("resultTable");

            table.innerHTML = ""; // reset b·∫£ng

            for (let docSnap of snapshot.docs) {

                const r = docSnap.data();

                const userSnap = await getDoc(doc(db, "users", r.studentId));
                const quizSnap = await getDoc(doc(db, "quizzes", r.quizId));

                const studentName = userSnap.exists() ? userSnap.data().fullname : "Unknown";
                const quizTitle = quizSnap.exists() ? quizSnap.data().title : "Deleted Quiz";
                const quizTopic = quizSnap.exists() ? quizSnap.data().topic : "-";
                const startTime = r.startTime
                    ? r.startTime.toDate().toLocaleString()
                    : "N/A";

                const timeTaken = r.timeTaken
                    ? Math.floor(r.timeTaken / 60) + " ph√∫t " + (r.timeTaken % 60) + " gi√¢y"
                    : "N/A";
                const submitTime = r.submittedAt?.toDate().toLocaleString() || "N/A";

                table.innerHTML += `
<tr>
    <td>${studentName}</td>
    <td>${quizTitle}</td>
    <td>${quizTopic}</td>
    <td>${r.score}/${r.total}</td>
    <td>${startTime}</td>
    <td>${submitTime}</td>
    <td>${timeTaken}</td>
    <td>
        <button onclick="viewResult('${docSnap.id}')">
            üëÅ
        </button>
    </td>
    <td>
        <button onclick="deleteResult('${docSnap.id}')">
            ‚ùå
        </button>
    </td>
</tr>
`;





            }
        }


        async function loadAdminQuizList() {

            const snapshot = await getDocs(collection(db, "quizzes"));
            const table = document.getElementById("quizTable");
            table.innerHTML = "";

            snapshot.forEach(docSnap => {

                const data = docSnap.data();

                table.innerHTML += `
            <tr>
                <td>${data.title}</td>
                <td>${data.topic}</td>
                <td>
                    <button class="btn btn-danger btn-sm"
                        onclick="deleteQuiz('${docSnap.id}')">
                        X√≥a
                    </button>
                </td>
            </tr>
           `;
            });
        }



        window.deleteResult = async function (resultId) {

            const confirmDelete = confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a k·∫øt qu·∫£ n√†y?");

            if (!confirmDelete) return;

            await deleteDoc(doc(db, "results", resultId));

            alert("ƒê√£ x√≥a k·∫øt qu·∫£!");

            loadAllResults(); // reload b·∫£ng
        }

        window.viewResult = async function (resultId) {

            const resultSnap = await getDoc(doc(db, "results", resultId));

            if (!resultSnap.exists()) {
                alert("Kh√¥ng t√¨m th·∫•y b√†i l√†m!");
                return;
            }

            const data = resultSnap.data();
            const answers = data.answers;

            if (!answers || answers.length === 0) {
                alert("B√†i l√†m c≈© ch∆∞a l∆∞u chi ti·∫øt.");
                return;
            }

            const win = window.open("", "_blank");

            win.document.title = "Chi ti·∫øt b√†i l√†m";

            const style = win.document.createElement("style");
            style.innerHTML = `
        body { font-family: Arial; padding:20px; background:#f3f4f6; }
        .question { background:white; padding:20px; margin-bottom:20px; border-radius:12px; }
        .answers { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:15px; }
        .item { padding:12px; border-radius:10px; border:1px solid #ccc; }
        .correct { background:#dcfce7; border:2px solid #16a34a; }
        .wrong { background:#fee2e2; border:2px solid #dc2626; }
    `;

            win.document.head.appendChild(style);

            const title = win.document.createElement("h2");
            title.innerText = "üìÑ Chi ti·∫øt b√†i l√†m";
            win.document.body.appendChild(title);

            answers.forEach((a, index) => {

                const questionDiv = win.document.createElement("div");
                questionDiv.className = "question";

                const h4 = win.document.createElement("h4");
                h4.innerText = "C√¢u " + (index + 1);

                const p = win.document.createElement("p");
                p.innerHTML = "<b>" + a.question + "</b>";

                const answersDiv = win.document.createElement("div");
                answersDiv.className = "answers";

                ["A", "B", "C", "D"].forEach(key => {

                    const item = win.document.createElement("div");
                    item.className = "item";

                    if (key === a.correct) item.classList.add("correct");
                    if (key === a.selected && key !== a.correct) item.classList.add("wrong");

                    item.innerHTML = "<b>" + key + ".</b> " + (a[key] || "");

                    answersDiv.appendChild(item);
                });

                questionDiv.appendChild(h4);
                questionDiv.appendChild(p);
                questionDiv.appendChild(answersDiv);

                win.document.body.appendChild(questionDiv);
            });
        };





        window.deleteAllResults = async function () {

            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô k·∫øt qu·∫£?")) return;

            const snapshot = await getDocs(collection(db, "results"));

            const batch = writeBatch(db);

            snapshot.docs.forEach(docSnap => {
                batch.delete(doc(db, "results", docSnap.id));
            });

            await batch.commit();

            alert("ƒê√£ x√≥a to√†n b·ªô k·∫øt qu·∫£!");
            loadAllResults();
        };


        window.deleteQuiz = async function (quizId) {

            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a quiz n√†y?")) return;

            // X√≥a questions tr∆∞·ªõc
            const questionsRef = collection(db, "quizzes", quizId, "questions");
            const questionsSnap = await getDocs(questionsRef);

            for (let docSnap of questionsSnap.docs) {
                await deleteDoc(doc(db, "quizzes", quizId, "questions", docSnap.id));
            }

            // X√≥a quiz
            await deleteDoc(doc(db, "quizzes", quizId));

            alert("ƒê√£ x√≥a quiz!");
            loadAdminQuizList();
        };


        async function loadMyScores() {

            const q = query(
                collection(db, "results"),
                where("studentId", "==", auth.currentUser.uid)
            );

            const snapshot = await getDocs(q);
            const ul = document.getElementById("myScores");

            snapshot.forEach(docSnap => {
                const r = docSnap.data();
                ul.innerHTML += `<li>${r.score}/${r.total}</li>`;
            });
        }

        async function loadChildScores(childId) {

            const q = query(
                collection(db, "results"),
                where("studentId", "==", childId)
            );

            const snapshot = await getDocs(q);
            const ul = document.getElementById("childScores");

            snapshot.forEach(docSnap => {
                const r = docSnap.data();
                ul.innerHTML += `<li>${r.score}/${r.total}</li>`;
            });
        }

        /* ===============================
           SHUFFLE
        ================================ */

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }



        function startTimer(minutes = 1) {

            timeLeft = minutes * 60;

            updateTimerDisplay();

            timerInterval = setInterval(() => {

                timeLeft--;

                updateTimerDisplay();

                if (timeLeft <= 0) {

                    clearInterval(timerInterval);
                    alert("H·∫øt gi·ªù! T·ª± ƒë·ªông n·ªôp b√†i.");
                    submitQuiz();
                }

            }, 1000);
        }

        function updateTimerDisplay() {

            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;

            document.getElementById("timer").innerText =
                `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        }
        let tabWarningCount = 0;

        document.addEventListener("visibilitychange", () => {

            if (document.hidden && quizStarted) {

                tabWarningCount++;

                if (tabWarningCount === 1) {
                    alert("C·∫£nh c√°o: Kh√¥ng ƒë∆∞·ª£c r·ªùi kh·ªèi tab khi ƒëang l√†m b√†i!");
                } else {
                    alert("B·∫°n ƒë√£ r·ªùi kh·ªèi tab l·∫ßn 2. B√†i s·∫Ω b·ªã n·ªôp t·ª± ƒë·ªông.");

                    if (timerInterval) clearInterval(timerInterval);

                    submitQuiz();
                }
            }

        });


        /* ===============================
           DOWNLOAD EXCEL TEMPLATE
        ================================ */

        window.downloadTemplate = function () {

            // D·ªØ li·ªáu m·∫´u
            const sampleData = [
                {
                    question: "What is the capital of France?",
                    A: "London",
                    B: "Berlin",
                    C: "Paris",
                    D: "Madrid",
                    correct: "C",
                    topic: "Geography"
                },
                {
                    question: "2 + 2 = ?",
                    A: "3",
                    B: "4",
                    C: "5",
                    D: "6",
                    correct: "B",
                    topic: "Math"
                }
            ];

            // T·∫°o worksheet
            const worksheet = XLSX.utils.json_to_sheet(sampleData);

            // T·∫°o workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "QuizTemplate");

            // Xu·∫•t file
            XLSX.writeFile(workbook, "quiz_template.xlsx");
        };

    </script>
</body>

</html>